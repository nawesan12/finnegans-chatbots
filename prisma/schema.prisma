generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  metaVerifyToken        String?
  metaAppSecret          String?
  metaAccessToken        String?
  metaPhoneNumberId      String?
  metaBusinessAccountId  String?

  contacts Contact[]
  flows    Flow[]
  broadcasts Broadcast[]
}

model Contact {
  id        String   @id @default(cuid())
  phone     String   @unique
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id])

  tags     TagsOnContacts[]
  logs     Log[]
  sessions Session[]
  broadcastRecipients BroadcastRecipient[]
}

model Tag {
  id   String @id @default(cuid())
  name String @unique

  contacts TagsOnContacts[]
}

model TagsOnContacts {
  contact   Contact @relation(fields: [contactId], references: [id])
  contactId String
  tag       Tag     @relation(fields: [tagId], references: [id])
  tagId     String

  @@id([contactId, tagId])
}

model Flow {
  id          String   @id @default(cuid())
  name        String
  trigger     String
  status      String   @default("Draft") // e.g., Draft, Active, Inactive
  definition  Json? // For react-flow JSON
  phoneNumber String?
  channel     String   @default("whatsapp")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  userId String
  user   User   @relation(fields: [userId], references: [id])

  logs     Log[]
  sessions Session[]
  broadcasts Broadcast[]
}

model Log {
  id        String   @id @default(cuid())
  status    String // e.g., "Completed", "In Progress", "Error"
  context   Json? // To store session variables
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contactId String
  contact   Contact @relation(fields: [contactId], references: [id])

  flowId String
  flow   Flow   @relation(fields: [flowId], references: [id])
}

model Session {
  id            String   @id @default(cuid())
  status        String   @default("Active") // e.g., Active, Paused, Completed, Errored
  currentNodeId String?
  context       Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  contactId String
  contact   Contact @relation(fields: [contactId], references: [id])
  flowId    String
  flow      Flow    @relation(fields: [flowId], references: [id])

  @@unique([contactId, flowId])
}

model Broadcast {
  id              String   @id @default(cuid())
  title           String?
  body            String
  filterTag       String?
  status          String   @default("Draft")
  totalRecipients Int      @default(0)
  successCount    Int      @default(0)
  failureCount    Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  userId String
  user   User @relation(fields: [userId], references: [id])

  flowId String?
  flow   Flow?  @relation(fields: [flowId], references: [id], onDelete: SetNull)

  recipients BroadcastRecipient[]
}

model BroadcastRecipient {
  id              String   @id @default(cuid())
  status          String   @default("Pending")
  error           String?
  messageId       String?  @unique
  conversationId  String?
  statusUpdatedAt DateTime?
  sentAt          DateTime?
  createdAt       DateTime @default(now())

  broadcastId String
  broadcast   Broadcast @relation(fields: [broadcastId], references: [id])

  contactId String
  contact   Contact @relation(fields: [contactId], references: [id])
}
